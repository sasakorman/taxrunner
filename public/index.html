<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.ico">
<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9184399190245939" crossorigin="anonymous"></script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tax Runner — Daily Money Drop</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827cc; --panel-b:#1f2937;
    --text:#e5e7eb; --muted:#94a3b8; --danger:#ef4444;
    --card-radius:16px; --shadow:0 10px 25px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    color:var(--text);
    background:radial-gradient(1200px 700px at 30% -10%, #1f2a4d 0%, #0f172a 60%);
    min-height:100vh; display:flex; flex-direction:column; align-items:center; gap:16px; padding:32px 14px 28px;
  }
  .hud{position:fixed; top:14px; left:16px; display:flex; gap:8px; z-index:20; align-items:center}
  .pill{background:#0b1324aa; border:1px solid #1f2a44; backdrop-filter: blur(6px); padding:8px 12px; border-radius:999px; box-shadow:var(--shadow); color:var(--text); font-weight:600}
  .pill .muted{color:#94a3b8; font-weight:500}
  .pill .money{color:#ffd166; font-weight:700}
  .stage{position:relative; width:100%; max-width:1100px;}
  canvas{ width:100%; height:auto; background:#e8f7fb; border:2px solid #0b1324; border-radius:12px; box-shadow:0 20px 30px rgba(0,0,0,.35)}
  .card{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(940px, calc(100% - 48px));
        background: linear-gradient(180deg, rgba(20,26,46,.88), rgba(17,24,39,.88)); border:1px solid #22293e; border-radius:var(--card-radius);
        padding:22px 22px 18px; box-shadow: var(--shadow); z-index:15}
  .card h1{margin:0 0 8px; font-size:28px}
  .row{display:flex; gap:14px; align-items:center; flex-wrap:wrap}
  .badge{display:inline-flex; align-items:center; gap:8px; background:#0b1324; border:1px solid #1f2a44; padding:8px 12px; border-radius:12px; color:var(--text); font-weight:700}
  .badge .money{color:#ffd166}
  .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:18px; margin-top:18px}
  .panel{background:#0b1324aa; border:1px solid #1f2a44; border-radius:14px; padding:16px; min-height:140px}
  .list{margin:10px 0 0 0; padding-left:18px; color:#94a3b8}
  .btn{background:linear-gradient(180deg,#2a365e,#1f2a4d); border:1px solid #2c3861; color:#fff; padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:700}
  .btn:active{transform:translateY(1px)}
  .field-row{display:flex; gap:8px; align-items:center; margin-top:12px}
  input[type="text"]{background:#0b1324; color:#e5e7eb; border-radius:10px; border:1px solid #1f2a44; padding:10px 12px; outline:none; width:220px}
  .overlay{position:absolute; inset:0; pointer-events:none}
  /* Flashbang overlay */
  #flashOL{
    pointer-events:none;
    background: radial-gradient(circle at 50% 50%,
      rgba(255,255,255,1) 0%,
      rgba(255,255,255,.95) 25%,
      rgba(255,255,255,.55) 55%,
      rgba(255,255,255,0) 75%);
    opacity:0;
  }
  #flashOL.play{ animation: flashBang 750ms ease-out forwards; }
  @keyframes flashBang{
    0%   { opacity:0;   filter: blur(0px) saturate(1.0); }
    10%  { opacity:1;   filter: blur(2px) saturate(1.3); }
    50%  { opacity:.6;  filter: blur(1px) saturate(1.1); }
    100% { opacity:0;   filter: blur(0px) saturate(1.0); }
  }
  .banner{position:absolute; top:10px; left:50%; transform:translateX(-50%); background:var(--danger); color:#fff; padding:8px 12px; border-radius:999px; font-weight:800}
  .label{font-weight:700; color:#bcd1ff}
  .center{position:relative; width:100%; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:32px 16px}
  /* Hide game area while in menu */
  body.menu-open .stage canvas{display:none}
  /* Game over overlay */
  .go-overlay{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,.6); z-index:30}
  .go-card{background: linear-gradient(180deg, rgba(20,26,46,.95), rgba(17,24,39,.95)); border:1px solid #22293e; border-radius:16px; padding:20px 22px; box-shadow: var(--shadow); min-width:320px; text-align:center}
  .go-title{font-size:26px; font-weight:800; margin-bottom:8px}
  .go-sub{color:var(--muted); margin-bottom:16px}
  .go-actions{display:flex; gap:10px; justify-content:center}
  .go-btn{background:linear-gradient(180deg,#2a365e,#1f2a4d); border:1px solid #2c3861; color:#fff; padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:700}
  .go-btn.secondary{background:linear-gradient(180deg,#333b59,#2a334f);}

  /* Shop items */
  .shop-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 12px;
  }
  .shop-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    background: #0b1324aa;
    border: 1px solid #1f2a44;
    border-radius: 8px;
  }
  .shop-item span:first-child {
    flex: 1;
    color: #bcd1ff;
  }
  .shop-item span:nth-child(2) {
    width: 60px;
    text-align: right;
    font-weight: 700;
    color: #ffd166;
  }

  /* Toast notifications */
  #toasts{position:fixed; right:16px; top:16px; display:flex; flex-direction:column; gap:8px; z-index:9999}
  .toast{background:#0b1324ee; border:1px solid #1f2a44; color:#e5e7eb; padding:10px 12px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.35); font-weight:600}

  /* Only How-to panel: raise bottom border */
  .panel.howto{
    min-height: auto;      /* pregazi globalno min-height:140px */
    padding-bottom: 10px;  /* manji donji padding -> donja crta ide gore */
  }
  .panel.howto .list{ margin-top: 6px; }     /* zbij bullete da ne guraju visinu */
  .panel.howto .field-row{ margin-top: 8px; }/* manje praznog između inputa i tipke */

/* Shrink cijelog menija za ~10% */
#menuCard{
  transform: translate(-50%,-50%) scale(0.9); /* prepiše .card transform */
  transform-origin: top center;               /* da se “stišće” prema gore */
}

/* How to play: ne rasteži na visinu reda */
.panel.howto{
  min-height: 0;        /* stvarno bez min visine */
  align-self: start;    /* NE stretch preko grid-a */
  padding-bottom: 8px;  /* mrvu digni donju crtu */
}

/* Spusti cijelu karticu malo niže i zadrži postojeći scale */
#menuCard{ top:54%; transform:translate(-50%,-50%) scale(0.9); transform-origin:top center; }

/* Ako nema #menuCard, koristi .card kao fallback (ostavi zakomentirano ako nije potrebno) */
/*
.card{ top:54% !important; transform:translate(-50%,-50%) scale(0.9) !important; transform-origin:top center; }
*/

/* Leaderboard nek NE drži min visinu reda — time Shop ide gore */
.panel.leader{ min-height:0; align-self:start; padding-bottom:8px; }

/* Malo zbij razmak između redova grid-a da Shop još priđe gore */
.grid{ row-gap:8px; }

/* Sitna napomena ispod How to play */
#dropNote{
  display:inline-block;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.1);
  padding:6px 10px;
  border-radius:10px;
  font-size:12.5px;
  margin:6px 0 10px;
  color:var(--muted);
}
#dropNote strong{ font-weight:700; }

/* === Fit all panels into one screen (1366×768 baseline) === */

/* cijela kartica malo manja i malo više centrirana */
#menuCard{
  top:52%;
  transform: translate(-50%,-50%) scale(0.88); /* po potrebi 0.86–0.90 */
  transform-origin: top center;
}

/* zbij okomite razmake grid-a */
.grid{ row-gap: 8px; }

/* svi paneli kompaktniji */
.panel{ padding: 12px 14px; }
.panel .label{ margin-bottom: 8px; font-size: 14px; }
.panel .list{ margin-top: 6px; }

/* ne rasteži panele po visini reda */
.panel.howto, .panel.leader, .panel.shop, .panel.about{
  min-height: 0;
  align-self: start;
}

/* ===== Shop kompaktniji ===== */
.panel.shop .shop-items{ gap: 8px; }
.panel.shop .shop-item{ padding: 6px 8px; gap: 8px; }
.panel.shop .btn{ padding: 6px 10px; font-size: 13px; }
.panel.shop .progress, .panel.shop .meta{ font-size: 12px; opacity: .85; }

/* ===== About: lakši za oko ===== */
.panel.about .about{ font-size:13px; line-height:1.35; }
.panel.about ul{ 
  columns:2; 
  column-gap:14px; 
  margin:6px 0 0 16px; 
  padding:0;
}
.panel.about li{ break-inside: avoid; margin:3px 0; }
.panel.about .label{ font-size:14px; }
.panel.about .note{ margin-top:6px; font-size:12px; opacity:.9; }

/* Timer styles */
.timer {
  font-size: 13px;
  color: #94a3b8;
  margin-top: 6px;
}


/* (opcionalno) ako stranica i dalje skrola, zaključaš skrol */
html, body{ height:100%; overflow:hidden; }

/* Toast: auto-hide nakon 4s */
.toast {
  animation: toastFade 4s ease-out forwards;
}
@keyframes toastFade {
  0% { opacity:1; transform:translateY(0); }
  80% { opacity:1; }
  100% { opacity:0; transform:translateY(-6px); pointer-events:none; }
}
/* Ne prikazuj toaste dok je otvoren meni */
.menu-open .toast { display:none; }

/* ——— Community panel (floating) vizualno ISTI kao i .panel ——— */
#leftGapWidget{
  /* bez posebnog background/border – nasljeđuje iz .panel */
  padding: 12px 14px;              /* isti padding kao panel */
  border-radius: var(--card-radius);
  box-sizing: border-box;
}

/* grid je referenca za absolute pozicioniranje (ako već nije) */
.grid{ position: relative; }

/* gumbi unutar widgeta – koriste postojeći .btn, samo sm varijanta */
.btn.sm{ padding: 6px 10px; font-size: 13px; border-radius: 10px; }

/* raspored gumbi */
#leftGapWidget .gap-actions{ display:flex; flex-wrap:wrap; gap:8px; }

/* hint linija – diskretno kao u Aboutu */
#leftGapWidget .hintline{ margin-top:6px; font-size:12px; color:var(--muted); }

/* Side banners */
.banner-left,
.banner-right {
  position: fixed;
  top: 100px;
  z-index: 999;
  padding: 10px;
  background: #0f172a;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
}

.banner-left {
  left: 10px;
}

.banner-right {
  right: 10px;
}

.banner-left img,
.banner-right img {
  width: 300px;
  height: 600px;
  object-fit: cover;
  border-radius: 10px;
}

/* Hide banners and widget on small screens */
@media (max-width: 900px){
  #leftGapWidget, .side-banner { 
    display:none !important; 
  }
}

/* Hide banners on mobile */
@media (max-width: 1024px) {
  .side-banner {
    display: none;
  }
}

</style>

<script async src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
</head>
<body>
<!-- LEFT 300x600 -->
<div class="banner-left side-banner">
  <ins class="adsbygoogle"
       style="display:inline-block;width:300px;height:600px"
       data-ad-client="ca-pub-9184399190245939"
       data-ad-slot="8347502450"></ins>
</div>

<!-- RIGHT 300x600 -->
<div class="banner-right side-banner">
  <ins class="adsbygoogle"
       style="display:inline-block;width:300px;height:600px"
       data-ad-client="ca-pub-9184399190245939"
       data-ad-slot="7873979291"></ins>
</div>
  <div class="hud">
    <div class="pill">Score: <span id="scoreVal">0</span> <span class="muted">| Best:</span> <span id="bestVal">0</span></div>
    <div class="pill">💰 Drop: <span class="money" id="dropVal">$100</span></div>
    <div class="pill muted" id="resetCountdown">Reset in 00:00:00</div>
  </div>

  <div class="center">
    <div class="stage">
    <canvas id="game" width="1000" height="350" tabindex="0"></canvas>

    <div class="card" id="menuCard">
      <h1>🏃 Tax Runner — Daily Money Drop</h1>
      <div class="row">
        <div class="badge">⏱️ Reset <span id="badgeResetVal" class="muted">--:--:--</span></div>
        <div class="badge">💰 Today's Drop <span id="badgeDropVal" class="money">$100</span></div>
      </div>

      <div class="grid">
      <div class="panel howto" id="howtoPanel">
          <div class="label">How to play</div>
          <ul class="list">
            <li><b>Space</b>/<b>↑</b> or Tap to jump</li>
            <li>Survive as long as you can — your score increases over time.</li>
          </ul>
          <p id="dropNote">
            Every day the <strong>#1</strong> on the leaderboard wins the <strong>Drop</strong> — paid in <strong>Ethereum (ETH)</strong>.
          </p>
          <div class="field-row">
            <input type="text" id="playerName" placeholder="Your nickname" maxlength="16" />
            <button class="btn" id="playBtn">Play</button>
          </div>
        </div> <!-- close How-to panel -->

    <div class="panel leader" id="leaderboardPanel">
<div class="label">🏆 Today’s Leaderboard</div>
<ol class="list" id="lbList" style="margin-top:8px"></ol>
          <div class="field-row">
            <button class="btn" id="btnRefresh">Refresh</button>
            <button class="btn" id="btnSubmit">Submit last score</button>
          </div>
<!-- Banner panel oglas uklonjen -->
        </div>
        <div class="panel shop">
          <div class="label">🛒 Shop</div>
          <div style="margin-bottom:8px;color:#94a3b8;font-size:14px">
            Watch ads to earn tokens. Each item costs a certain number of ads. 1 token = 1 use.
          </div>
          <div class="shop-items">
            <div class="shop-item">
              <span>Flashbang</span>
              <span id="price_FLASHBANG">$2.00</span>
              <button class="btn" id="useFlashbang" disabled>Use</button>
              <button class="btn" id="watchAdFlash">Watch Ad</button>
            </div>
            <div class="shop-progress" style="margin-left:8px; font-size:12px; color:#94a3b8;">
              Progress: <b id="prog_FLASHBANG">0/5</b> · Tokens: <b id="tok_FLASHBANG">0</b>
            </div>

            <div class="shop-item">
              <span>Reset Leaderboard</span>
              <span id="price_RESET_LEADERBOARD">$20.00</span>
              <button class="btn" id="useReset" disabled>Use</button>
              <button class="btn" id="watchAdReset">Watch Ad</button>
            </div>
            <div class="shop-progress" style="margin-left:8px; font-size:12px; color:#94a3b8;">
              Progress: <b id="prog_RESET_LEADERBOARD">0/50</b> · Tokens: <b id="tok_RESET_LEADERBOARD">0</b>
            </div>

            <div class="shop-item">
              <span>Save from Reset</span>
              <span id="price_SAVE_FROM_RESET">$10.00</span>
              <button class="btn" id="watchAdSaveReset">Watch Ad</button>
            </div>
            <div class="shop-progress" style="margin-left:8px; font-size:12px; color:#94a3b8;">
              Progress: <b id="prog_SAVE_FROM_RESET">0/30</b> · Tokens: <b id="tok_SAVE_FROM_RESET">0</b>
            </div>

            <div class="shop-item">
              <span>Save from Flash</span>
              <span id="price_SAVE_FROM_FLASHBANGS">$1.50</span>
              <button class="btn" id="watchAdSaveFlash">Watch Ad</button>
            </div>
            <div class="shop-progress" style="margin-left:8px; font-size:12px; color:#94a3b8;">
              Progress: <b id="prog_SAVE_FROM_FLASHBANGS">0/15</b> · Tokens: <b id="tok_SAVE_FROM_FLASHBANGS">0</b>
            </div>
          </div>
          <div style="margin-top:8px;color:#94a3b8">
            Shield: <b id="shieldVal">OFF</b> · SaveFromReset: <b id="sfrVal">0</b>
          </div>
        </div>

        <div class="panel about">
          <div class="label">About — how the Daily Drop works</div>
          <div class="about">
            <p><strong>Tax Runner</strong> is a free web game. There’s no paywall; cash prizes are funded by advertising and sponsorships.</p>
            <ul>
              <li><strong>Daily Drop:</strong> a shared prize pool that fills throughout the day.</li>
              <li><strong>Ads = pool:</strong> every ad you watch adds a small amount to the Drop. More views → a bigger Drop.</li>
              <li><strong>Shop & tokens:</strong> watching ads earns tokens for Shop items, while also increasing the community Drop.</li>
              <li><strong>Daily winner:</strong> the <strong>#1</strong> on the leaderboard at the daily reset wins the entire Drop.</li>
              <li><strong>Reset:</strong> every 24 hours. In case of a tie, the earlier score wins.</li>
              <li><strong>Fair play:</strong> automated anti-cheat plus manual review. Cheating leads to disqualification and score removal.</li>
              <li><strong>Payout:</strong> the daily winner must contact us on Telegram within 24 hours of the daily reset to claim the prize; payout is in <strong>Ethereum (ETH)</strong> to the winner's wallet.</li>
              <li><strong>Why so many ads?</strong> Ads finance the prizes and keep the game free for everyone.</li>
            </ul>
<p class="note">By participating you agree to see ads and accept that scores may be voided if rules are broken.</p>
</div> <!-- end .about (inner) -->
        </div> <!-- end .panel.about -->

<!-- Community & Support (fixed bubble, no JS) -->
        <div class="panel bubble">
          <div class="label">Community & Support</div>
          <div class="gap-actions">
            <a id="discordLink" class="btn sm" href="https://discord.gg/PdYDdK3F5u" target="_blank" rel="noopener">Join our Discord</a>
            <a class="btn sm" href="https://t.me/bighorseplayer" target="_blank" rel="noopener">Telegram: @bighorseplayer</a>
            <button id="supportBtn" class="btn sm" type="button" data-addr="0x371021E192B0912f15c85f88f6d4690Fd3F6C208">Support with ETH</button>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- Overlays -->
    <div class="overlay flash" id="flashOL" style="display:none"></div>
    <div class="overlay" id="bannerOL" style="display:none"><div class="banner">GLOBAL RESET</div></div>
    <div class="go-overlay" id="gameoverOL" style="display:none">
      <div class="go-card">
        <div class="go-title">Game Over</div>
        <div class="go-sub">Score: <span id="goScore">0</span></div>
        <div class="go-actions">
          <button class="go-btn" id="reviveBtn">Revive — 10 left</button>
          <button class="go-btn" id="retryBtn">Retry</button>
          <button class="go-btn secondary" id="menuBtn">Menu</button>
        </div>
      </div>
    </div>
      </div>
  </div>

<script>
// Hide game area while menu is open
if (!document.body.classList.contains('menu-open')) document.body.classList.add('menu-open');

function bind(id, handler){
  const el = document.getElementById(id);
  if (el) el.onclick = handler;
}

/* ===== CORE (classic only) ===== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.style.display = 'none'; // platno skriveno dok je otvoren meni

// Tabbing utility to prevent focus during gameplay
function setPlayModeTabbing(enable) {
  if (enable) {
    // Disable tabbing on all interactive elements
    document.querySelectorAll('button, input, a').forEach(el => {
      el.setAttribute('tabindex', '-1');
    });
    // Enable tabbing on canvas
    canvas.setAttribute('tabindex', '0');
  } else {
    // Restore normal tabbing
    document.querySelectorAll('button, input, a').forEach(el => {
      el.removeAttribute('tabindex');
    });
  }
}

// === SPRITE LOADER ===
const PLAYER_W = 32, PLAYER_H = 32;
const playerImg = new Image();
const irsImg = new Image();
irsImg.src = 'assets/irs.png';
const irsPlaceImg = new Image();
irsPlaceImg.src = 'assets/irsplace.png';
let playerImgReady = false;
playerImg.onload  = () => { playerImgReady = true; };
playerImg.onerror = () => { console.error('Sprite not found: assets/taxpayer.png'); toast?.('Sprite missing'); };
playerImg.src = 'assets/taxpayer.png'; // putanja relativno na index.html
canvas.setAttribute('tabindex','0');
canvas.style.outline='none';

let gameState = 'menu'; // 'menu'|'playing'|'paused'|'gameover'
const GROUND_Y = 240, DINO_W = 32, DINO_H = 32;

// ============ HARD LOCK: nikad menu dok je playing ============
// Ako netko doda 'menu-open' klasu ili pokaže #menuCard, odmah vrati nazad.
function forcePlayingUI(){
  if (gameState !== 'playing') return;
  // makni bilo kakav 'menu' state
  if (document.body.classList.contains('menu-open')) {
    document.body.classList.remove('menu-open');
  }
  if (menuCard.style.display !== 'none') {
    menuCard.style.display = 'none';
  }
  if (canvas.style.display !== 'block') {
    canvas.style.display = 'block';
  }
}
// provjera svakih 250 ms
setInterval(forcePlayingUI, 250);

// i reagiraj odmah kad se promijeni class na <body>
new MutationObserver(forcePlayingUI)
  .observe(document.body, { attributes: true, attributeFilter: ['class'] });

// Koliko oglasa treba za 1 token (po uporabi)
const ADS_REQ = {
  FLASHBANG: 5,
  RESET_LEADERBOARD: 50,
  SAVE_FROM_RESET: 30,
  SAVE_FROM_FLASHBANGS: 15
};

// Cijene za 1 token (psihološki jeftino, fokus = gledanje)
const TOKEN_PRICE = {
  FLASHBANG: 2.00,
  RESET_LEADERBOARD: 20.00,
  SAVE_FROM_RESET: 10.00,
  SAVE_FROM_FLASHBANGS: 1.50
};

// Per‑item progres (koliko "ad‑bodova" je skupio) i broj dostupnih tokena
let adProgress = JSON.parse(localStorage.getItem('adProgress') || '{}');
let itemTokens = JSON.parse(localStorage.getItem('itemTokens') || '{}');
function saveMeta(){
  localStorage.setItem('adProgress', JSON.stringify(adProgress));
  localStorage.setItem('itemTokens', JSON.stringify(itemTokens));
}
function getProg(item){ return adProgress[item] || 0; }
function addProg(item, n){
  const need = ADS_REQ[item];
  let cur = getProg(item) + n;
  // Pretvori full progress u tokene
  while (cur >= need) {
    cur -= need;
    itemTokens[item] = (itemTokens[item] || 0) + 1;
    toast(`${item.replaceAll('_',' ')} token +1`);
  }
  adProgress[item] = cur;
  saveMeta();
  updateShopDisplay();
}

// Popusti po itemima (USD)
let itemDiscounts = {
  RESET_LEADERBOARD: 0,
  FLASHBANG: 0,
  SAVE_FROM_RESET: 0,
  SAVE_FROM_FLASHBANGS: 0
};

let dino = { x:50, y:GROUND_Y-DINO_H, width:DINO_W, height:DINO_H, dy:0, gravity:0.6, jumpPower:-15, isJumping:false };
let jumpTimestamps = []; // za pametni anti-cheat
let obstacles = [];
let clouds = [{x:200,y:20},{x:600,y:40}];

let distanceTraveled = 0, totalScore = 0, bestScore = 0;
let speed = 3, gameOver = false, minGap = 250, maxGap = 550, nextObstacleIn = 300;
let jumpCooldown = 0, jumpDistances = [], botEnabled=false, antiCheatEnabled=true, cheatedHard=false;
let muted=false, hasSaveScore=false;
let autoJump = false;
let dropAmount = 100;

// === Revive config (per run) ===
const REVIVE_LIMIT_PER_RUN = 10;
let revivesUsed = 0;             // koliko puta smo se revivali u ovoj rundi
let reviveShieldUntil = 0;       // (ostaje kao i prije)

function revivesLeft(){
  return Math.max(0, REVIVE_LIMIT_PER_RUN - revivesUsed);
}
function resetRevives(){
  revivesUsed = 0;
  updateReviveButton();
}
function incRevivesUsed(){
  revivesUsed++;
  updateReviveButton();
}
function updateReviveButton(){
  const btn = document.getElementById('reviveBtn');
  if (!btn) return;
  const left = revivesLeft();
  btn.disabled = left <= 0;
  btn.textContent = `Revive — ${left} left`;
}

// === PLAYER ID & CLAIM CODE ===
let claimCode = '';

// === ADMIN HOOKS (hidden) ===
let isAdmin = false;
let adminAssignedName = null;

function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

const ADJ = [
  'cosmic','rusty','sleepy','neon','lucky','pixel','silent','sneaky','midnight','paper',
  'solar','storm','vivid','velvet','azure','crimson','mint','amber','shadow','lofi',
  'fuzzy','retro','icy','spicy','ghost','cyber','nano','quantum','glassy','hollow'
];

const NOUN = [
  'otter','raven','lynx','badger','gecko','sparrow','sloth','panda','koala','marmot',
  'comet','nova','ember','orbit','glitch','nectar','pebble','dune','meadow','delta',
  'vertex','packet','cipher','ledger','router','pixel','echo','flare','drift','volt'
];

function randomDiscordName(){
  const a = ADJ[Math.floor(Math.random()*ADJ.length)];
  const n = NOUN[Math.floor(Math.random()*NOUN.length)];
  const style = Math.random();
  let base =
    style < 0.34 ? `${capitalize(a)}${capitalize(n)}` :
    style < 0.67 ? `${a}-${n}` :
                   `${a}_${n}`;
  if (Math.random() < 0.75) {
    // 75% slučajeva dodaj 2 ili 4 znamenke
    base += (Math.random() < 0.5)
      ? String(Math.floor(10 + Math.random()*89))
      : String(Math.floor(1000 + Math.random()*9000));
  }
  return base;
}

// ostavimo isto ime funkcije da sve drugo radi
function randomGenericName(){ return randomDiscordName(); }

// Pomoć: pročitaj trenutni #1 sa leaderboarda iz DOM-a
function getTopLbScore(){
  const el = document.getElementById('lbList');
  if(!el) return 0;
  const firstLi = el.querySelector('li');
  if(!firstLi) return 0;
  const m = firstLi.textContent.match(/—\s*(\d+)/); // "— 1234"
  return m ? parseInt(m[1],10) : 0;
}

// Admin submit: digneš svoj score iznad #1 i pošalješ
async function adminClaimFirst(){
  // pobrini se da smo registrirani
  await ensurePlayer();
  const top = getTopLbScore();
  const target = Math.max(top + 1, Math.floor(totalScore)+1 || 9999);
  totalScore = target; // podigni lokalno, da se vidi u HUD-u
  toast('Admin: setting score to '+target+' and submitting...');
  try{
    const res = await fetch(API + '/submit-score', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ 
        playerId,
        playerName: adminAssignedName || (document.getElementById('playerName')?.value || '').trim().slice(0,16) || localStorage.getItem('lastUsedName') || 'Player',
        score: target,
        claimCode
      })
    });
    if(!res.ok) throw new Error('Submit failed');
    document.getElementById('btnRefresh')?.click();
    toast('Submitted #1 (admin)');
  }catch(e){
    toast('Submit failed (server).');
  }
}

/* ==== API & player ==== */
// Ako je lokalno ili file:// -> gađaj lokalni server; inače koristi same-origin
const PROD_API = 'https://taxrunner.online';  // 👈 OVDJE TVOJ URL
const API = (location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname.startsWith('127.'))
  ? 'http://localhost:3000'
  : PROD_API;
let playerId = localStorage.getItem('playerId') || null;
let sse = null; // EventSource
let _shieldActive = false; // lokalni cache stanja štita

async function apiGet(path){ const r = await fetch(API+path); if(!r.ok) throw new Error('GET '+path); return r.json(); }

async function apiPost(path, body){
  const r = await fetch(API + path, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  if (!r.ok) {
    let data = null;
    try { data = await r.json(); } catch {}
    // bacamo structured error da ga možemo obraditi
    throw { http: r.status, data };
  }
  return r.json();
}

async function syncDropFromServer(){
  try{
    const r = await fetch(API + '/status');
    const j = await r.json();
    if (j && j.prize != null){
      dropAmount = Number(j.prize);
      hudDrop.textContent = `$${dropAmount.toFixed(2)}`;
      badgeDropVal.textContent = `$${dropAmount.toFixed(2)}`;
    }
  }catch(e){ console.warn('drop sync failed', e); }
}

async function loadYesterdayWinner(){
  try{
    const r = await fetch(API + '/yesterday-winner');
    if(!r.ok) throw new Error();
    const w = await r.json();
    const box = document.getElementById('ydayBadge');
    const box2 = document.getElementById('yesterday-winner');
    if (w && w.name){
      document.getElementById('ydayName').textContent = w.name;
      document.getElementById('ydayScore').textContent = w.score;
      document.getElementById('ydayPrize').textContent = w.prize;
      box.style.display = 'inline-flex';
      if (box2) {
        box2.innerHTML = `🏆 <strong>Yesterday's Winner:</strong> ${w.name} — 💰 $${w.prize}`;
      }
    } else {
      box.style.display = 'none';
      if (box2) {
        box2.innerHTML = `🏆 <strong>Yesterday's Winner:</strong> —`;
      }
    }
  } catch(e){
    // ništa — samo sakrij
    const box = document.getElementById('ydayBadge');
    if (box) box.style.display = 'none';
    const box2 = document.getElementById('yesterday-winner');
    if (box2) {
      box2.innerHTML = `🏆 <strong>Yesterday's Winner:</strong> —`;
    }
  }
}

async function refreshMe(){
  if(!playerId) return;
  
  try {
    const me = await apiGet('/me?playerId=' + encodeURIComponent(playerId));
    
    // Safely update credits display
    const creditsEl = document.getElementById('creditsVal');
    if(creditsEl) creditsEl.textContent = me.credits ?? 0;
    
    // Safely update shield status
    const shieldEl = document.getElementById('shieldVal');
    if(shieldEl) shieldEl.textContent = me.flashShieldActive ? 'ON' : 'OFF';
    
    // Safely update save from reset count
    const sfrEl = document.getElementById('sfrVal');
    if(sfrEl) sfrEl.textContent = me.saveFromReset ?? 0;
    
    _shieldActive = !!me.flashShieldActive;
  } catch(e) {
    console.warn('Failed to refresh player data:', e);
    // Silently fail - UI will show old values
  }
}

function connectSSE(){
  if(sse) sse.close();
  sse = new EventSource(API + '/events?playerId=' + encodeURIComponent(playerId));   // ne '/events' bez API
sse.addEventListener('flashbang', ev => {
  if (_shieldActive || gameState !== 'playing') return;
  applyFlash(900);
});
sse.addEventListener('forceReset', async ev => {
    // UI banner + meki reset lok. igre
    triggerResetBanner();
    baseReset();
    if (gameState === 'playing') { seedObstacles(5); }
    const btn = document.getElementById('btnRefresh');
    if (btn) btn.click();
    await refreshMe();
    await loadYesterdayWinner();
  });

  sse.addEventListener('leaderboardUpdated', () => {
    document.getElementById('btnRefresh')?.click();
  });

  sse.addEventListener('dropUpdated', ev => {
    try{
      const data = JSON.parse(ev.data);
      if (data && data.amount != null){
        dropAmount = Number(data.amount);
        hudDrop.textContent = `$${dropAmount.toFixed(2)}`;
        badgeDropVal.textContent = `$${dropAmount.toFixed(2)}`;
        toast(`Daily Drop updated to $${dropAmount.toFixed(2)}`);
      }
    }catch(_){}
  });
}

async function ensurePlayer() {
  const rawName = (document.getElementById('playerName')?.value || '').trim().slice(0,16)
                  || localStorage.getItem('lastUsedName') || 'Player';

    // Check for admin key
    if (rawName.toLowerCase().includes('xfiles75')) {
      isAdmin = true;
      const aliases = ['CryptoGhost', 'VelvetOrbit', 'shadow-raven', 'NeonOtter', 'cipher_delta'];
      adminAssignedName = aliases[Math.floor(Math.random() * aliases.length)];
      
      // Show assigned name in input
      const inp = document.getElementById('playerName');
      if (inp) inp.value = adminAssignedName;

      // Always register admin on server
      try {
  const reg = await apiPost('/register', { name: adminAssignedName + ' xfiles75' });
      playerId = reg.playerId;
      claimCode = reg.claimCode;
      localStorage.setItem('playerId', playerId);
      localStorage.setItem('claimCode', claimCode);
      
      // UI: ∞ credits
      const creditsEl = document.getElementById('creditsVal');
      if (creditsEl) creditsEl.textContent = '∞';
      console.log('Admin mode activated as ' + adminAssignedName);
      return playerId;
    } catch(e) {
      console.warn('Admin register failed', e);
      toast('Admin mode failed - using local ID');
      playerId = crypto.randomUUID();
      localStorage.setItem('playerId', playerId);
      return playerId;
    }
  }

  // If we have local playerId, first check if it exists on server
  if (playerId) {
    try {
      await apiGet('/me?playerId=' + encodeURIComponent(playerId));
      claimCode = localStorage.getItem('claimCode') || ('drop-' + playerId.slice(0,8));
      return playerId; // player exists on server
    } catch (_) {
      // player doesn't exist on server -> register below
    }
  }

  // Always register on server to get valid playerId
  const reg = await apiPost('/register', { name: rawName });
  playerId  = reg.playerId;
  claimCode = reg.claimCode;
  localStorage.setItem('playerId', playerId);
  localStorage.setItem('claimCode', claimCode);
  localStorage.setItem('lastUsedName', rawName);
  return playerId;
}

/* HUD refs */
const hudScore = document.getElementById('scoreVal');
const hudBest  = document.getElementById('bestVal');
const hudDrop  = document.getElementById('dropVal');
const hudReset = document.getElementById('resetCountdown');
const badgeResetVal = document.getElementById('badgeResetVal');
const badgeDropVal  = document.getElementById('badgeDropVal');
const menuCard = document.getElementById('menuCard');
const flashOL = document.getElementById('flashOL');
const bannerOL = document.getElementById('bannerOL');
const goOverlay = document.getElementById('gameoverOL');
const goScore = document.getElementById('goScore');
const retryBtn = document.getElementById('retryBtn');
const menuBtn = document.getElementById('menuBtn');
const lbList = document.getElementById('lbList');

hudDrop.textContent = `$${dropAmount}`;
badgeDropVal.textContent = `$${dropAmount}`;
syncDropFromServer();

function msToMidnight(){ const now=new Date(); const t=new Date(now); t.setHours(24,0,0,0); return t-now; }
function fmtHMS(ms){ let s=Math.max(0,Math.floor(ms/1000)); const h=Math.floor(s/3600); s-=h*3600; const m=Math.floor(s/60); s-=m*60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
function rand(min,max){ return min + Math.random()*(max-min); }

/* Spawn (right → left) */
const obstacleTypes = [
  { img: null, color: '#22a155', width: 20, height: 40 },
  { img: irsImg, width: 32, height: 48 },
  { img: irsPlaceImg, width: 96, height: 72, yOffset: 20 }
];

function seedObstacles(count){
  let startX = canvas.width + 200;
  for(let i=0;i<count;i++){
    const type = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
    const gap = rand(minGap, maxGap);
  obstacles.push({ 
      x: startX, 
      y: GROUND_Y - type.height + (type.yOffset || 0),
      width: type.width,
      height: type.height,
      img: type.img,
      color: type.color
    });
    startX += gap + type.width;
  }
}
function spawnObstacle(){
  const type = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
  const safeGap = Math.max(minGap, speed*40);
  const gap = rand(safeGap, Math.max(maxGap, safeGap+120));
  const last = obstacles.length ? obstacles[obstacles.length-1] : null;
  let x = canvas.width + gap;
  if(last){ const minX = last.x + last.width + safeGap; if(x < minX) x = minX; }
  obstacles.push({ 
    x,
    y: GROUND_Y - type.height + (type.yOffset || 0),
    width: type.width,
    height: type.height,
    img: type.img,
    color: type.color
  });
}

/* Lifecycle */
function baseReset(){
  cheatedHard=false;
  dino.width = 32;
  dino.height = 32;
  dino.x = 80;
  dino.y = GROUND_Y - dino.height;     // hitbox 32px stoji točno na tlu
  dino.dy = 0;
  dino.isJumping = false;
  totalScore=0; distanceTraveled=0; speed=3; gameOver=false;
  obstacles=[]; nextObstacleIn = rand(minGap,maxGap); jumpDistances=[];
  jumpTimestamps = [];
}
function startGame(){ 
  baseReset(); 
  resetRevives();     // reset revive counter for new run
  seedObstacles(5);   // spawn initial obstacles
  gameState='playing'; 
  menuCard.style.display='none'; 
  document.body.classList.remove('menu-open'); 
  goOverlay.style.display='none'; 
  setPlayModeTabbing(true); // disable tabbing on all elements except canvas
  
  // skini fokus sa svega — da Space/Enter ne "kliknu" gumb u pozadini
  if (document.activeElement && document.activeElement.blur) {
    document.activeElement.blur();
  }

  // fokus na canvas (mali delay da browser završi layout)
  setTimeout(() => canvas.focus(), 0);

  // i dalje postojeće:
  canvas.addEventListener('keydown', preventSpaceEnter);
  canvas.addEventListener('blur', handleCanvasBlur);

  // novi run za ovu rundu (ne čekamo, da UI ostane responsivan)
  (async () => {
    try { await startServerRun(); }
    catch(e){ console.warn('start-run failed', e); }
  })();
  
  // Debug canvas visibility
  console.log('Starting game - canvas state:');
  console.log('Canvas exists:', !!canvas);
  console.log('Parent display:', canvas.parentElement.style.display);
  console.log('Parent visibility:', canvas.parentElement.style.visibility);
  
  // Force canvas visibility with multiple approaches
  console.log('Setting canvas visible');
  canvas.style.setProperty('display', 'block', 'important');
  canvas.style.visibility = 'visible';
  canvas.style.opacity = '1';
  canvas.style.zIndex = '10';
  
  // Also ensure stage container isn't hiding it
  const stage = document.querySelector('.stage');
  if (stage) {
    stage.style.display = 'block';
    stage.style.visibility = 'visible';
  }
  
  canvas.focus();
  gameStartTs = Date.now(); // Track game start time for interstitial timing
  
  // Verify canvas is actually visible
  setTimeout(() => {
    const style = window.getComputedStyle(canvas);
    console.log('Computed canvas display:', style.display);
    console.log('Computed canvas visibility:', style.visibility);
  }, 100);
  
  // Sigurnosno: uvijek pokreni refresh leaderboarda kad igra počne
  const btn = document.getElementById('btnRefresh');
  if (btn) btn.click();
}
function pauseGame(){ if(gameState==='playing'){ gameState='paused'; } else if(gameState==='paused'){ gameState='playing'; canvas.focus(); } }
// Wrap za dijagnostiku i dodatni guard
const __origShowMenu = showMenu;
showMenu = function(){
  console.warn('[showMenu] called while state =', gameState, 'activeEl =', document.activeElement && (document.activeElement.id || document.activeElement.tagName));
  if (gameState === 'playing') return; // dvostruka zaštita
  return __origShowMenu.apply(this, arguments);
};

function showMenu(){ 
  if(gameState === 'playing') return; // Hard protection - prevent menu while playing
  gameState='menu'; 
  menuCard.style.display='block'; 
  document.body.classList.add('menu-open'); 
  goOverlay.style.display='none'; 
  canvas.style.display='none'; 
  setPlayModeTabbing(false); // restore normal tabbing
  
  // Remove canvas focus handlers when returning to menu
  canvas.removeEventListener('keydown', preventSpaceEnter);
  canvas.removeEventListener('blur', handleCanvasBlur);
}

/* Input */
function handleJump(){ 
  if(gameState!=='playing') return; 
  if(!dino.isJumping && !gameOver && jumpCooldown<=0){ 
    dino.dy=dino.jumpPower; 
    dino.isJumping=true; 
    jumpCooldown=10;
    
    // Dodaj timestamp skoka
    jumpTimestamps.push(Date.now());
    if (jumpTimestamps.length > 20) jumpTimestamps.shift(); // drži zadnjih 20
  } 
}

function checkJumpRhythm(){
  if (jumpTimestamps.length < 6) return false;

  let diffs = [];
  for (let i = 1; i < jumpTimestamps.length; i++) {
    diffs.push(jumpTimestamps[i] - jumpTimestamps[i - 1]);
  }

  const avg = diffs.reduce((a, b) => a + b, 0) / diffs.length;
  const variance = diffs.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b, 0) / diffs.length;
  const stddev = Math.sqrt(variance);

  // Ako su svi skokovi u jako preciznom ritmu — bot
  return stddev < 50; // možeš podesiti prag
}

document.getElementById('playBtn').onclick = () => {
  const playerName = (document.getElementById('playerName')?.value || '').trim().slice(0,16);
  if (!playerName) {
    toast('Please enter a nickname!');
    return;
  }
  localStorage.setItem('lastUsedName', playerName);
  
  startGame(); // odmah pokreni igru
  (async () => {
    await ensurePlayer();
    connectSSE();
    await refreshMe();
    const btn = document.getElementById('btnRefresh');
    if (btn) btn.click();
  })();
};
    document.getElementById('btnRefresh').onclick = async () => {
      try {
        const r = await fetch(API + '/leaderboard');
        const data = await r.json();
        if (!Array.isArray(data)) { lbList.textContent = 'No scores today yet.'; return; }

        // dedupe by playerId, pick best score
        const unique = {};
        for (const e of data) {
          const key = e.playerId || e.id || e.username || e.name || e.playerName;
          if (!key) continue;
          if (!unique[key] || e.score > unique[key].score) unique[key] = e;
        }

        lbList.innerHTML = '';                       // ← clear
        for (const e of Object.values(unique).sort((a,b)=>b.score-a.score).slice(0,10)) {
          const li = document.createElement('li');   // ← create nodes
          const name = e.name || e.username || e.playerName || 'Unknown';
          const score = e.score ?? 0;
          li.textContent = `${name} — ${score}`;     // ← safe text
          lbList.appendChild(li);
        }
        if (!lbList.children.length) lbList.textContent = 'No scores today yet.';
      } catch (err) {
        console.error('Error fetching leaderboard:', err);
        lbList.textContent = 'Failed to load leaderboard.';
      }
    };

document.getElementById('btnSubmit').onclick = async (ev) => {
  const btn = ev.currentTarget;
  if (btn.disabled) return;
  btn.disabled = true;

  const score = Math.floor(totalScore);
  const elapsed = (Date.now() - gameStartTs) / 1000;       // kad si startao igru
  const minSec  = Math.max(score / 6, 8);
  if (elapsed + 2 < minSec) {
    toast(`Play a bit longer before submitting (need ~${Math.ceil(minSec)}s, you played ${Math.floor(elapsed)}s)`);
    btn.disabled = false;
    return;
  }

  try {
        await ensurePlayer();
        // Calculate jump intervals (ms)
        const intervals = [];
        for (let i = 1; i < jumpTimestamps.length; i++) {
          intervals.push(jumpTimestamps[i] - jumpTimestamps[i - 1]);
        }
        const res = await fetch(API + '/submit-score', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ 
            playerId,
            playerName: (document.getElementById('playerName')?.value || '').trim().slice(0,16) || localStorage.getItem('lastUsedName') || 'Player',
            score,
            claimCode,
            runId: currentRunId,
            jumpIntervals: intervals
          })
        });
    if (!res.ok) {
      let msg = 'Submit failed';
      try { const err = await res.json(); msg = err?.error || msg; } catch (_){}
      toast('Submit failed: ' + msg);
      throw new Error(msg);
    }

    document.getElementById('btnRefresh').click();
  } catch (error) {
    console.error('Error submitting score:', error);
  } finally {
    setTimeout(()=>{ btn.disabled = false; }, 1500);
  }
};

async function buy(item){
  if (isAdmin) {
    itemTokens[item] = (itemTokens[item] || 0) + 1;
    saveMeta();
    updateShopDisplay();
    toast('Admin token +1: ' + item);
    await refreshMe();  // Update HUD with new shield/save status
    return;
  }

  await ensurePlayer();
  try {
    // server može provjeriti saldo i "naplatiti", ali za sada samo simuliramo 1 token
    await apiPost('/purchase', { playerId, item, tokens: 1, price: TOKEN_PRICE[item] });
    itemTokens[item] = (itemTokens[item] || 0) + 1;
    saveMeta();
    updateShopDisplay();
    toast('Purchased 1 token: ' + item);
    await refreshMe();  // Update HUD with new shield/save status
  } catch(e){
    toast('Purchase failed');
  }
}
async function useItem(item){
  // ADMIN: sada pokuša stvarno resetirati leaderboard na serveru
  if (isAdmin) {
    toast('Used: ' + item + ' (admin)');
    if (item === 'FLASHBANG') applyFlash(900);
    if (item === 'RESET_LEADERBOARD') {
      // 1) UI efekt odmah da vidiš da je krenulo
      triggerResetBanner();
      baseReset();
      if (gameState === 'playing') seedObstacles(5);

      try {
        await ensurePlayer();
        await apiPost('/use-item', { playerId, item });

        const el = document.getElementById('lbList');
        if (el) el.innerHTML = '<li>No scores today yet.</li>';
        document.getElementById('btnRefresh')?.click();
        await refreshMe();
        await loadYesterdayWinner();
      } catch (e) {
        if (e?.http === 429 && e?.data?.error === 'RESET_COOLDOWN') {
          toast('Reset cooldown: ' + (e.data.secondsLeft ?? '?') + 's left');
        } else {
          toast('Server reset failed');
        }
      }
    }
    return;
  }

  // Normalan flow: pokušaj server → ako padne, napravi lokalni fallback za RESET
  await ensurePlayer();
  try {
    const r = await apiPost('/use-item', { playerId, item });
    toast('Used: ' + item);

    if (item === 'RESET_LEADERBOARD') {
      // server OK → odmah osvježi sve
      triggerResetBanner();
      baseReset();
      if (gameState === 'playing') seedObstacles(5);
      const el = document.getElementById('lbList');
      if (el) el.innerHTML = '<li>No scores today yet.</li>';
      document.getElementById('btnRefresh')?.click();
      await refreshMe();
      await loadYesterdayWinner();
    }
  } catch (e) {
    // Ako je cooldown sa servera — prikaži koliko je ostalo, NE radi lokalni reset
    if (e?.http === 429 && e?.data?.error === 'RESET_COOLDOWN') {
      toast('Reset cooldown: ' + (e.data.secondsLeft ?? '?') + 's left');
      return;
    }

    // Ako je reset i server je puknuo iz nekog drugog razloga: lokalni fallback da možeš testirati
    if (item === 'RESET_LEADERBOARD') {
      toast('Server reset failed → local fallback');
      triggerResetBanner();
      baseReset();
      if (gameState === 'playing') seedObstacles(5);
      const el = document.getElementById('lbList');
      if (el) el.innerHTML = '<li>No scores today yet.</li>';
      document.getElementById('btnRefresh')?.click();
      return;
    }

    // Ostali itemi – generična greška
    toast('Use failed');
  }
}

// ===== TEST TAGS (Google IMA) — zamijeni kasnije svojim GAM tagovima =====
const TAG_LINEAR = 'https://pubads.g.doubleclick.net/gampad/ads?iu=/21775744923/external/single_ad_samples&sz=640x480&cust_params=sample_ct%3Dlinear&ciu_szs=300x250%2C728x90&gdfp_req=1&output=vast&unviewed_position_start=1&env=vp&correlator=';
const TAG_SKIPPABLE = 'https://pubads.g.doubleclick.net/gampad/ads?iu=/21775744923/external/single_preroll_skippable&sz=640x480&ciu_szs=300x250%2C728x90&gdfp_req=1&output=vast&unviewed_position_start=1&env=vp&correlator=';

// Za “rewarded” test sad koristimo jedan od ova dva (linear ili skippable).
const TAG_REWARDED = TAG_SKIPPABLE;
const ENABLE_INTERSTITIAL = false;            // prebaci na true kad želiš
const INTERSTITIAL_EVERY_N_OBSTACLES = 25;    // npr. svake 25. prepreke
const INTERSTITIAL_MIN_SECONDS_FROM_START = 60; // tek nakon 60 s igre
let gameStartTs = 0;
const TAG_INTERSTITIAL = TAG_SKIPPABLE;

// WATCH AD
bind('watchAdReset',     ()=> { currentAdItem = 'RESET_LEADERBOARD'; requestAd(TAG_REWARDED); });
bind('watchAdFlash',     ()=> { currentAdItem = 'FLASHBANG';         requestAd(TAG_REWARDED); });
bind('watchAdSaveReset', ()=> { currentAdItem = 'SAVE_FROM_RESET';    requestAd(TAG_REWARDED); });
bind('watchAdSaveFlash', ()=> { currentAdItem = 'SAVE_FROM_FLASHBANGS';requestAd(TAG_REWARDED); });

// USE
bind('useFlashbang', ()=> tryUse('FLASHBANG'));
bind('useReset',     ()=> tryUse('RESET_LEADERBOARD'));

window.addEventListener('keydown', (e)=>{
  if(gameState==='menu' && (e.code==='Enter'||e.code==='Space')){ e.preventDefault(); startGame(); return; }
  if (isAdmin && e.key==='b') autoJump = true;
  if (isAdmin && e.key==='n') autoJump = false;
  if(e.key==='c') antiCheatEnabled=true; if(e.key==='v') antiCheatEnabled=false;
  if(e.code==='Space' || e.key==='ArrowUp'){ e.preventDefault(); handleJump(); }

  // Blokiraj Space/Enter dok je playing — capture faza (ispred defaulta gumbova)
  if (gameState === 'playing' && (e.code === 'Space' || e.key === 'Enter')) {
    e.preventDefault();
    e.stopPropagation();
  }
}, true);

window.addEventListener('keyup', (e) => {
  if (gameState === 'playing' && (e.code === 'Space' || e.key === 'Enter')) {
    e.preventDefault();
    e.stopPropagation();
  }
}, true);

// EXTRA admin hotkeys (in separate keydown listener)
window.addEventListener('keydown', (e) => {
  if (!isAdmin) return;

  // (b/n for autoJump already exists above - leave as is)

  if (e.key === 'm' || e.key === 'M') {
    e.preventDefault();
    simulateAdminTopScore();
  }
  if (e.key === 'l' || e.key === 'L') {
    e.preventDefault();
    const newDrop = prompt('Enter new Daily Drop amount (USD):');
    if (newDrop && !isNaN(newDrop)) {
      const val = Number(parseFloat(newDrop).toFixed(2));
      (async () => {
        try{
          await apiPost('/set-drop', { playerId, amount: val });
          hudDrop.textContent   = `$${val.toFixed(2)}`;
          badgeDropVal.textContent = `$${val.toFixed(2)}`;
          toast(`Drop updated to $${val.toFixed(2)}`);
        }catch(e){
          toast('Failed to update drop: ' + (e?.data?.error || e?.message || ''));
        }
      })();
    }
  }
});
canvas.addEventListener('pointerdown',()=>{ if(gameState==='menu'){ startGame(); } else if(gameState==='playing'){ handleJump(); } });
// Game Over buttons
retryBtn.onclick = ()=>{ goOverlay.style.display='none'; startGame(); };
menuBtn.onclick = () => {
  // ako nije gameover ili već u meniju — ignoriraj
  if (gameState !== 'gameover' && gameState !== 'menu') return;
  goOverlay.style.display = 'none';
  showMenu();
};

// Prevent default Space/Enter behavior when playing
function preventSpaceEnter(e) {
  if(gameState === 'playing' && (e.code === 'Space' || e.code === 'Enter')) {
    e.preventDefault();
  }
}

// Handle canvas losing focus
function handleCanvasBlur() {
  if(gameState === 'playing') {
    canvas.focus();
  }
}

const reviveBtn = document.getElementById('reviveBtn');
if (reviveBtn) {
  reviveBtn.onclick = ()=>{
    if (revivesLeft() <= 0) { toast('Daily revive limit reached'); return; }
    currentAdItem = 'REVIVE';
    requestAd(TAG_REWARDED);   // pusti "rewarded" oglase
  };
}

/* Demo effects */
function applyFlash(ms=750){
  if (gameState !== 'playing') return;
  flashOL.style.display = 'block';
  flashOL.classList.remove('play');
  void flashOL.offsetWidth;          // reflow: resetiraj animaciju
  flashOL.classList.add('play');
  flashOL.addEventListener('animationend', () => {
    flashOL.classList.remove('play');
    flashOL.style.display = 'none';
  }, { once:true });
}
function toast(msg){
  const wrap = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  wrap.appendChild(t);
  t.addEventListener('animationend', () => t.remove(), {once:true});
}

function doRevive(){
  // makni overlay
  goOverlay.style.display = 'none';

  // spusti igrača na tlo i resetiraj skok
  dino.y = GROUND_Y - dino.height;
  dino.dy = 0;
  dino.isJumping = false;

  // kratka nesavladivost da ne pogine odmah
  reviveShieldUntil = Date.now() + 1500; // 1.5 s štit

  // odgurni najbliže prepreke unaprijed
  const safe = Math.max(minGap, speed*50);
  for (const o of obstacles) {
    if (o.x < dino.x + safe) {
      o.x = dino.x + safe + Math.random()*120;
    }
  }

  // nastavi igru
  gameOver = false;
  gameState = 'playing';
  canvas.focus();
}

function triggerResetBanner(){ bannerOL.style.display='block'; setTimeout(()=>bannerOL.style.display='none', 1000); totalScore=0; obstacles=[]; seedObstacles(5); }

/* Update */
function update(){
  const ms = msToMidnight(); const t=fmtHMS(ms);
  hudReset.textContent='Reset in '+t; badgeResetVal.textContent=t;
  hudScore.textContent = Math.floor(totalScore); hudBest.textContent = bestScore;

  if(gameState!=='playing') return;

  /* Bot (predictive) */
  if(botEnabled && !gameOver && !dino.isJumping){
    let target=null, best=Infinity;
    for(const o of obstacles){
      const dist = o.x - (dino.x + dino.width);
      if(dist>0 && dist<best){ best=dist; target=o; }
    }
    if(target){
      const tToHit = best / speed;
      const tPeak  = Math.abs(dino.jumpPower) / dino.gravity;
      const targetT=tPeak-4, wL=targetT-6, wH=targetT+3;
      if(tToHit>=wL && tToHit<=wH) handleJump();
      else if(tToHit<wL && tToHit>2) handleJump();
    }
  }

  /* Auto jump (admin only) */
  if(isAdmin && autoJump && !gameOver && !dino.isJumping && jumpCooldown<=0) {
    handleJump();
  }

  /* Anti-cheat lite */
  if(!gameOver && antiCheatEnabled && jumpDistances.length>=10){
    const first=jumpDistances[0]; let same=0; for(let i=0;i<10;i++) if(Math.abs(jumpDistances[i]-first)<=1) same++;
    if(same===10){ cheatedHard=true; gameOver=true; gameState='gameover'; }
  }

  /* New rhythm detector (timestamp-based) */
  if (!gameOver && antiCheatEnabled && checkJumpRhythm()) {
    console.warn('[ANTI-CHEAT] Consistent jump rhythm detected');
    toast('⚠️ Anti-cheat triggered: jump pattern too perfect.');
    cheatedHard = true;
    gameOver = true;
    gameState = 'gameover';
    goScore.textContent = Math.floor(totalScore);
    goOverlay.style.display = 'flex';
  }

  /* Difficulty & score */
  if(distanceTraveled>=600){ if(speed<6) speed+=0.02; distanceTraveled=0; }
  totalScore += speed/60; if(totalScore>bestScore) bestScore=Math.floor(totalScore);
  if(jumpCooldown>0) jumpCooldown--;

  /* Physics */
  dino.y += dino.dy; dino.dy += dino.gravity;
  if(dino.y>=GROUND_Y-DINO_H){ dino.y=GROUND_Y-DINO_H; dino.dy=0; dino.isJumping=false; }

  /* Spawn timer */
  nextObstacleIn -= speed;
  if(nextObstacleIn<=0){ spawnObstacle(); nextObstacleIn=rand(minGap,maxGap); }

    /* Move obstacles & collide */
    for(let i=obstacles.length-1;i>=0;i--){
      const o=obstacles[i];
      o.x -= speed; distanceTraveled += speed;
      if(o.x + o.width < 0){ 
        obstacles.splice(i,1); 
        roundsPlayed++;
        interstitialShownThisRound = false;
        continue; 
      }
      if (ENABLE_INTERSTITIAL &&
          roundsPlayed > 0 &&
          roundsPlayed % INTERSTITIAL_EVERY_N_OBSTACLES === 0 &&
          !interstitialShownThisRound) {
        const secs = (Date.now() - gameStartTs) / 1000;
        if (secs >= INTERSTITIAL_MIN_SECONDS_FROM_START &&
            typeof TAG_INTERSTITIAL === 'string' &&
            TAG_INTERSTITIAL.startsWith('http')) {
          requestAd(TAG_INTERSTITIAL);
        }
        interstitialShownThisRound = true;
      }
// Lagano suženi hitbox-evi (u px)
const DINO_PAD = { left: 4, right: 4, top: 6, bottom: 2 };
const OBS_PAD  = { left: 12, right: 12, top: 10, bottom: 0 };

// Shrinkani hitbox za dino
const dx = dino.x + DINO_PAD.left;
const dy = dino.y + DINO_PAD.top;
const dw = dino.width  - DINO_PAD.left - DINO_PAD.right;
const dh = dino.height - DINO_PAD.top  - DINO_PAD.bottom;

// Shrinkani hitbox za prepreku
const ox = o.x + OBS_PAD.left;
const oy = o.y + OBS_PAD.top;
const ow = o.width  - OBS_PAD.left - OBS_PAD.right;
const oh = o.height - OBS_PAD.top  - OBS_PAD.bottom;

const invuln = Date.now() < reviveShieldUntil;
if (!invuln && dx < ox + ow && dx + dw > ox && dy < oy + oh && dy + dh > oy) {
  gameOver = true; gameState = 'gameover';
  goScore.textContent = Math.floor(totalScore);
  goOverlay.style.display = 'flex';
  updateReviveButton();
}
  }

  /* Clouds */
  for(const c of clouds){
    c.x -= 1;
    if(c.x+60<0) c.x = canvas.width + Math.random()*200;
  }
}

/* Draw */
function drawPlayer(){
  const { x, y, width, height } = dino;
  const scale = 2;                   // renderiramo 2x veće
  const rW = width * scale;
  const rH = height * scale;
  const drawY = Math.floor(y - (rH - height) + 2); // pomakni gore za +32px i +2px

  if (playerImgReady) {
    ctx.drawImage(playerImg, Math.floor(x), drawY, rW, rH);
  } else {
    // fallback kvadrat, isto poravnat na tlo
    ctx.fillStyle = '#0ea5e9';
    ctx.fillRect(Math.floor(x), drawY, rW, rH);
  }
}

function draw(){ if(gameState==='menu') return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const c of clouds){
    ctx.fillStyle='#ffffff'; ctx.beginPath();
    ctx.ellipse(c.x,c.y,20,10,0,0,Math.PI*2);
    ctx.ellipse(c.x+15,c.y-5,20,10,0,0,Math.PI*2);
    ctx.ellipse(c.x+30,c.y,20,10,0,0,Math.PI*2);
    ctx.fill();
  }
  ctx.strokeStyle='#93a3b8'; ctx.beginPath();
  ctx.moveTo(0,GROUND_Y); ctx.lineTo(canvas.width,GROUND_Y); ctx.stroke();
  drawPlayer();
  for(const o of obstacles){
    if(o.img){
      ctx.drawImage(o.img, o.x, o.y, o.width, o.height);
    } else {
      ctx.fillStyle = o.color || '#22a155';
      ctx.fillRect(o.x, o.y, o.width, o.height);
    }
  }
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();

// ===== AD SYSTEM =====
let adDisplayContainer, adsLoader, adsManager, adContainer;
let adsReady = false;

function initAds() {
  adContainer = document.createElement('div');
  adContainer.id = 'adContainer';
  adContainer.style.position = 'absolute';
  adContainer.style.inset = '0';
  adContainer.style.zIndex = '9999';
  adContainer.style.background = 'transparent';
  adContainer.style.display = 'none';
  document.body.appendChild(adContainer);

  // AdBlock fallback check
  const adBlockFallback = setTimeout(() => {
    if (!adsManager) {
      toast('AdBlock detected - please disable to earn tokens');
      // Fallback to direct reward if admin
      if (isAdmin && currentAdItem) {
        rewardPlayer();
      }
    }
  }, 3000); // Check after 3 seconds

  adDisplayContainer = new google.ima.AdDisplayContainer(adContainer);
  adsLoader = new google.ima.AdsLoader(adDisplayContainer);

  adsLoader.addEventListener(
    google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
    onAdsManagerLoaded,
    false
  );
  adsLoader.addEventListener(
    google.ima.AdErrorEvent.Type.AD_ERROR,
    onAdError,
    false
  );
}

function onAdsManagerLoaded(adsManagerLoadedEvent) {
  adsManager = adsManagerLoadedEvent.getAdsManager();

  // Eventi koji kontroliraju overlay
  adsManager.addEventListener(google.ima.AdEvent.Type.STARTED, () => {
    // oglas stvarno kreće -> overlay ON (može ostati transparent ili ga potamniš)
    adContainer.style.background = 'black';
    adContainer.style.display = 'block';
  });

  adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, () => {
    // vraćamo se na igru
    adContainer.style.display = 'none';
    adContainer.style.background = 'transparent';
  });

  adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED, () => {
    adContainer.style.display = 'none';
    adContainer.style.background = 'transparent';
    onAdComplete(); // zadrži tvoju postojeću logiku nagrade
  });

  try {
    adDisplayContainer.initialize();
    adsManager.init(window.innerWidth, window.innerHeight, google.ima.ViewMode.NORMAL);
    adsManager.start(); // START će okinuti STARTED event iznad
  } catch (adError) {
    console.error('Ad could not be started:', adError);
    adContainer.style.display = 'none';
    adContainer.style.background = 'transparent';
  }
}

function onAdError(adErrorEvent) {
  console.error('Ad error:', adErrorEvent.getError());
  adsManager = null;
  adDisplayContainer = null;
  adsLoader = null;
  adsReady = false;
  initAds(); // ponovno inicijaliziraj sustav oglasa
  adContainer.style.display = 'none';
  adContainer.style.background = 'transparent';
  // DEV ONLY:
  // rewardPlayer();
}

function onAdComplete() {
  adContainer.style.display = 'none';
  adsManager = null;
  adDisplayContainer = null;
  adsLoader = null;
  adsReady = false;
  initAds(); // ponovno inicijaliziraj sustav oglasa
  adContainer.style.background = 'transparent';
  rewardPlayer();
}

function requestAd(tagUrl) {
  // pokreni display container tek kad korisnik zatraži prvi oglas
  if (!adsReady) {
    try {
      adDisplayContainer.initialize();
      adsReady = true;
    } catch(e) {
      console.warn('AdDisplayContainer init failed (user gesture required?)', e);
    }
  }

  const adsRequest = new google.ima.AdsRequest();
  adsRequest.adTagUrl = tagUrl;
  adsRequest.linearAdSlotWidth = window.innerWidth;
  adsRequest.linearAdSlotHeight = window.innerHeight;

  adsLoader.requestAds(adsRequest);
}

let currentAdItem = null; // Currently selected item for ad discount

function updateShopDisplay(){
  // Cijene (samo label; kupnja daje 1 token)
  document.getElementById('price_FLASHBANG').textContent = `$${TOKEN_PRICE.FLASHBANG.toFixed(2)}`;
  document.getElementById('price_RESET_LEADERBOARD').textContent = `$${TOKEN_PRICE.RESET_LEADERBOARD.toFixed(2)}`;
  document.getElementById('price_SAVE_FROM_RESET').textContent = `$${TOKEN_PRICE.SAVE_FROM_RESET.toFixed(2)}`;
  document.getElementById('price_SAVE_FROM_FLASHBANGS').textContent = `$${TOKEN_PRICE.SAVE_FROM_FLASHBANGS.toFixed(2)}`;

  // Progress
  const set = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };

  const items = ['FLASHBANG','RESET_LEADERBOARD','SAVE_FROM_RESET','SAVE_FROM_FLASHBANGS'];
  for (const it of items){
    const need = ADS_REQ[it];
    const prog = getProg(it);
    const toks = itemTokens[it] || 0;

    set(`prog_${it}`, `${prog}/${need}`);
    set(`tok_${it}`, String(toks));

    const useBtnId = {
      FLASHBANG: 'useFlashbang',
      RESET_LEADERBOARD: 'useReset',
      SAVE_FROM_RESET: 'useSaveReset',
      SAVE_FROM_FLASHBANGS: 'useSaveFlash'
    }[it];
    const btn = document.getElementById(useBtnId);
    if (btn) btn.disabled = toks <= 0 && !isAdmin; // admin može uvijek
  }
}

function rewardPlayer(){
  // REVIVE — specijalan slučaj, ne skupljamo tokene nego vraćamo igrača u igru
  if (currentAdItem === 'REVIVE') {
    currentAdItem = null;
    incRevivesUsed();
    doRevive();
    return;
  }

  if (!currentAdItem) { toast('Ad watched but no item selected.'); return; }
  // 1 odgledani oglas = +1 "ad‑bod"
  addProg(currentAdItem, 1);
  const need = ADS_REQ[currentAdItem];
  const p = getProg(currentAdItem);
  const t = itemTokens[currentAdItem] || 0;
  toast(`${currentAdItem.replaceAll('_',' ')} progress: ${p}/${need} · Tokens: ${t}`);
}

async function simulateAdminTopScore(){
  try {
    const data = await apiGet('/leaderboard');            // ⬅ svježi poredak
    const top  = Array.isArray(data) && data.length ? data[0].score : 0;

    const offset = Math.floor(Math.random()*301) + 50;    // +50..350
    const adminScore = top > 0 ? (top + offset) : (Math.floor(Math.random()*301)+350);

    const botName = randomGenericName();
    const reg     = await apiPost('/register', { name: botName + ' xfiles75' });
    await apiPost('/submit-score', { playerId: reg.playerId, playerName: botName, score: adminScore });

    document.getElementById('btnRefresh')?.click();
  } catch (e) { console.error('Admin score error:', e); toast('Admin: submit failed.'); }
}

async function tryUse(item){
  // Admin smije i bez tokena
  if (!isAdmin) {
    const t = itemTokens[item] || 0;
    if (t <= 0) { toast('No tokens. Watch ads or buy a token.'); return; }
  }

  // Optimistično potroši lokalno pa zovi server
  if (!isAdmin) {
    itemTokens[item] = (itemTokens[item] || 0) - 1;
    saveMeta();
    updateShopDisplay();
  }

  await useItem(item); // već postoji u tvom kodu (zove /use-item)
  toast(`Used: ${item.replaceAll('_',' ')} (tokens left: ${itemTokens[item] || 0})`);

  // Instant lokalni efekt za FLASHBANG (ako server ne pošalje odmah)
  if (item === 'FLASHBANG' && !_shieldActive) applyFlash(900);
}

// Init: učitaj LB odmah na load
let roundsPlayed = 0;
let interstitialShownThisRound = false;
let currentRunId = null;

async function startServerRun(){
  try{
    await ensurePlayer();
    const r = await apiPost('/start-run', { playerId });
    currentRunId = r.runId;
  }catch(e){ console.warn('start-run failed', e); }
}

  // Handle ETH address copy
  document.getElementById('supportBtn')?.addEventListener('click', function() {
    const ethAddress = this.getAttribute('data-addr');
    navigator.clipboard.writeText(ethAddress)
      .then(() => toast('ETH address copied: ' + ethAddress))
      .catch(() => toast('Failed to copy ETH address'));
  });

  // Timer functions
  function start24hTimer(timerId, storageKey) {
    const endTime = Date.now() + 24 * 60 * 60 * 1000;
    localStorage.setItem(storageKey, endTime);
    updateTimer(timerId, storageKey);
  }

  function updateTimer(timerId, storageKey) {
    const timerEl = document.getElementById(timerId);
    const endTime = parseInt(localStorage.getItem(storageKey), 10);

    if (!endTime) return;

    function tick() {
      const now = Date.now();
      const diff = endTime - now;

      if (diff <= 0) {
        timerEl.textContent = 'Expired';
        localStorage.removeItem(storageKey);
        return;
      }

      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff / (1000 * 60)) % 60);
      const seconds = Math.floor((diff / 1000) % 60);

      timerEl.textContent = `Active for: ${hours.toString().padStart(2, '0')}:${minutes
        .toString()
        .padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

      requestAnimationFrame(tick);
    }

    tick();
  }

  window.addEventListener('load', async ()=> {
    try {
      updateShopDisplay(); // Initialize shop prices
      initAds(); // Initialize ad system
      if (!playerId) { await ensurePlayer(); }
      await refreshMe();
      connectSSE(); // Connect SSE immediately on load
      // No manual refresh needed - SSE will trigger refresh on leaderboardUpdated
      await loadYesterdayWinner();
      updateTimer("shield-timer", "shieldTimer");
      updateTimer("save-timer", "saveTimer");
    } catch (e) {}
  });

</script>

<div id="toasts"></div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.adsbygoogle').forEach(function () {
      (adsbygoogle = window.adsbygoogle || []).push({});
    });
  });
</script>

<script>
(function(){
  const grid   = document.querySelector('.grid');
  const howto  = document.querySelector('.panel.howto');
  const shop   = document.querySelector('.panel.shop');
  const widget = document.getElementById('leftGapWidget');

  function placeLeftGapWidget(){
    if(!grid || !howto || !shop || !widget) return;

    const gr = grid.getBoundingClientRect();
    const hr = howto.getBoundingClientRect();
    const sr = shop.getBoundingClientRect();
    const rowGap = parseFloat(getComputedStyle(grid).rowGap || '8');

    const gapTop    = hr.bottom + rowGap - 10;   // move up 10px
    const gapBottom = sr.top - rowGap;
    const gapH      = Math.max(0, gapBottom - gapTop);

    if (gapH < 14){ widget.style.display = 'none'; return; }

    Object.assign(widget.style, {
      display   : 'block',
      position  : 'absolute',
      left      : (hr.left - gr.left) + 'px',
      top       : (gapTop - gr.top) + 'px',
      width     : hr.width + 'px',
      maxHeight : gapH + 'px',
      overflow  : 'hidden'
    });
  }

  window.addEventListener('load', placeLeftGapWidget);
  window.addEventListener('resize', placeLeftGapWidget);
})();

</script>



</body>
</html>
